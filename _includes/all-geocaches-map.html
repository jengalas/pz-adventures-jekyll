<div class="fullscreen-map-wrapper">
  <div id="map" class="map" style="height: 600px;"></div>
</div>

<!-- Load common basemaps -->
<script src="/assets/js/basemaps.js"></script>
<script>

  const map = L.map('map').setView([48.2083537, 16.3725042], 2)

  objBasemaps['USGS Topo'].addTo(map); // Assign default basemap

  L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
    subdomains: 'abcd'
  }).addTo(map)

  const jsontest = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-16.5471268, 28.4136726]
        },
        "properties": {
          "Name": "Gran Hotel, Puerto de la Cruz",
          "year": '1890',
          "month": "February",
          "days": "11-13th",
          "organiser": "Pedro Reid, English tradesman living in Puerto de la Cruz",
          "eventType": "funfair",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.1753895, 41.3767925]
        },
        "properties": {
          "Name": "Teatro Circo, Barcelona",
          "year": '1890',
          "month": "February-March",
          "days": "early",
          "organiser": "Charles Kalb, representative of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.8241, 41.98219]
        },
        "properties": {
          "Name": "Casino, Girona",
          "year": '1890',
          "month": "March",
          "days": "early",
          "organiser": "Charles Kalb",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.188959, 41.4304234]
        },
        "properties": {
          "Name": "Teatre Sant Andreu, Barcelona",
          "year": '1890',
          "month": "September",
          "days": "",
          "organiser": "Paz y Esperanza choir",
          "eventType": "free-exhibition",
          "notes": "for working class communities"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [4.2660212, 39.8887063]
        },
        "properties": {
          "Name": "Claustros del Carmen, Maó",
          "year": '1892',
          "month": "June",
          "days": "",
          "organiser": "Mr Natini",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-2.4635124, 36.834363]
        },
        "properties": {
          "Name": "Unknown location, Almería",
          "year": '1892',
          "month": "August",
          "days": "ca. 12",
          "organiser": "Mr Freixas",
          "eventType": "paying-exhibition",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-4.4809735, 36.6559053]
        },
        "properties": {
          "Name": "Town Hall, Málaga",
          "year": '1892',
          "month": "mid-August",
          "days": "",
          "organiser": "unclear, possibly Mr Freixas, as he was in Almería shortly before this",
          "eventType": "unknown",
          "notes": "likely to be a paying-exhibition"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.7032321, 40.4168227]
        },
        "properties": {
          "Name": "Hotel de París, Madrid",
          "year": '1892',
          "month": "November",
          "days": "1",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.7003922, 40.4155335]
        },
        "properties": {
          "Name": "Teatro de la Comedia, Madrid",
          "year": '1892',
          "month": "December",
          "days": "3",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.710345, 40.4232612]
        },
        "properties": {
          "Name": "Teatro Coliseum, Madrid",
          "year": '1892',
          "month": "January",
          "days": "11",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.704428, 40.422096]
        },
        "properties": {
          "Name": "Teatro Lara, Madrid",
          "year": '1892',
          "month": "February",
          "days": "24",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.6961898, 40.4192079]
        },
        "properties": {
          "Name": "Teatro Apolo, Madrid",
          "year": '1892',
          "month": "December",
          "days": "1",
          "organiser": "unknown - likely Mr Sears and Mr Warring, representatives of Edison, as they had been touring the Madrid theatres with a phonograph during the previous weeks",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.6464342, 39.5699375]
        },
        "properties": {
          "Name": "Passeig del Born, in front of Centro Militar, Palma de Mallorca",
          "year": '1892',
          "month": "June",
          "days": "",
          "organiser": "Mr Natini (representative of Demeyer)",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-1.6450463, 42.8154445]
        },
        "properties": {
          "Name": "Paseo de Valencia, Pamplona",
          "year": '1893',
          "month": "July",
          "days": "ca. 6",
          "organiser": "Sr. Freixas",
          "eventType": "funfair",
          "notes": "fiestas del Paseo de Valencia"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-1.6428161, 42.8168971]
        },
        "properties": {
          "Name": "Fonda Ángel, Pamplona\n",
          "year": '1893',
          "month": "mid-July",
          "days": "",
          "organiser": "Organizers: Sr. Freixas",
          "eventType": "paying-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.1763815, 41.3818165]
        },
        "properties": {
          "Name": "Fonógrafo Soley, Barcelona",
          "year": '1893',
          "month": "August",
          "days": "",
          "organiser": "?",
          "eventType": "paying-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-8.7256683, 42.2382719]
        },
        "properties": {
          "Name": "Café Méndez Núñez, Vigo\n",
          "year": '1893',
          "month": "September",
          "days": "21",
          "organiser": "Mr Shelton, from Chicago",
          "eventType": "unknown",
          "notes": ""
        }
      }
    ]
  };

  //array to store layers for each feature type

  const mapLayerGroupsYear = {};
  const mapLayerGroupsType = {};

  function onEachFeature(feature, layer) {
    const yearKey = feature.properties.year;
    const typeKey = feature.properties.eventType;

    // YEAR layer group
    if (!mapLayerGroupsYear[yearKey]) {
      mapLayerGroupsYear[yearKey] = L.layerGroup().addTo(map);
    }

    // EVENT TYPE layer group
    if (!mapLayerGroupsType[typeKey]) {
      mapLayerGroupsType[typeKey] = L.layerGroup().addTo(map);
    }

    layer.bindPopup(feature.properties.eventType);

    // Add the feature to BOTH groups
    mapLayerGroupsYear[yearKey].addLayer(layer);
    mapLayerGroupsType[typeKey].addLayer(layer);
  }


  L.geoJSON(jsontest, {
    onEachFeature: onEachFeature,
    pointToLayer: (point, latlng) => {
      const className = point.properties.year + " " + point.properties.eventType
      const icon = new L.Icon.Default({ className: className }) // create custom icon from default icon
      return L.marker(latlng, { icon: icon })
    }
  })

  L.control.layers(objBasemaps, {
    ...mapLayerGroupsYear,
    ...mapLayerGroupsType
  }).addTo(map);


</script>