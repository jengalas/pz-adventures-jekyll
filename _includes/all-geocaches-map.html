<link rel="stylesheet" href="https://unpkg.com/leaflet-groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.css" />
<script src="https://unpkg.com/leaflet-groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<div class="fullscreen-map-wrapper">
  <div id="map" class="map" style="height: 600px;"></div>
</div>

<!-- Load common basemaps -->
<script src="/assets/js/basemaps.js"></script>
<script>
  /* ------------------ Map setup ------------------ */

  const map = L.map('map').setView([48.2, 16.37], 2);

  objBasemaps['OpenStreetMap'].addTo(map); // Assign default basemap

  /* ------------------ Data ------------------ */

  const jsontest = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-16.5471268, 28.4136726]
        },
        "properties": {
          "Name": "Gran Hotel, Puerto de la Cruz",
          "user": 'Rich',
          "month": "February",
          "days": "11-13th",
          "organiser": "Pedro Reid, English tradesman living in Puerto de la Cruz",
          "eventType": "funfair",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.1753895, 41.3767925]
        },
        "properties": {
          "Name": "Teatro Circo, Barcelona",
          "user": 'Rich',
          "month": "February-March",
          "days": "early",
          "organiser": "Charles Kalb, representative of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.8241, 41.98219]
        },
        "properties": {
          "Name": "Casino, Girona",
          "user": 'Rich',
          "month": "March",
          "days": "early",
          "organiser": "Charles Kalb",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.188959, 41.4304234]
        },
        "properties": {
          "Name": "Teatre Sant Andreu, Barcelona",
          "user": 'Rich',
          "month": "September",
          "days": "",
          "organiser": "Paz y Esperanza choir",
          "eventType": "free-exhibition",
          "notes": "for working class communities"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [4.2660212, 39.8887063]
        },
        "properties": {
          "Name": "Claustros del Carmen, Maó",
          "user": 'Zhanna',
          "month": "June",
          "days": "",
          "organiser": "Mr Natini",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-2.4635124, 36.834363]
        },
        "properties": {
          "Name": "Unknown location, Almería",
          "user": 'Zhanna',
          "month": "August",
          "days": "ca. 12",
          "organiser": "Mr Freixas",
          "eventType": "paying-exhibition",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-4.4809735, 36.6559053]
        },
        "properties": {
          "Name": "Town Hall, Málaga",
          "user": 'Zhanna',
          "month": "mid-August",
          "days": "",
          "organiser": "unclear, possibly Mr Freixas, as he was in Almería shortly before this",
          "eventType": "unknown",
          "notes": "likely to be a paying-exhibition"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.7032321, 40.4168227]
        },
        "properties": {
          "Name": "Hotel de París, Madrid",
          "user": 'Zhanna',
          "month": "November",
          "days": "1",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.7003922, 40.4155335]
        },
        "properties": {
          "Name": "Teatro de la Comedia, Madrid",
          "user": 'Zhanna',
          "month": "December",
          "days": "3",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.710345, 40.4232612]
        },
        "properties": {
          "Name": "Teatro Coliseum, Madrid",
          "user": 'Zhanna',
          "month": "January",
          "days": "11",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.704428, 40.422096]
        },
        "properties": {
          "Name": "Teatro Lara, Madrid",
          "user": 'Zhanna',
          "month": "February",
          "days": "24",
          "organiser": "Mr Sears and Mr Warring, representatives of Edison",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-3.6961898, 40.4192079]
        },
        "properties": {
          "Name": "Teatro Apolo, Madrid",
          "user": 'Zhanna',
          "month": "December",
          "days": "1",
          "organiser": "unknown - likely Mr Sears and Mr Warring, representatives of Edison, as they had been touring the Madrid theatres with a phonograph during the previous weeks",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.6464342, 39.5699375]
        },
        "properties": {
          "Name": "Passeig del Born, in front of Centro Militar, Palma de Mallorca",
          "user": 'Zhanna',
          "month": "June",
          "days": "",
          "organiser": "Mr Natini (representative of Demeyer)",
          "eventType": "trade-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-1.6450463, 42.8154445]
        },
        "properties": {
          "Name": "Paseo de Valencia, Pamplona",
          "user": 'Rich',
          "month": "July",
          "days": "ca. 6",
          "organiser": "Sr. Freixas",
          "eventType": "funfair",
          "notes": "fiestas del Paseo de Valencia"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-1.6428161, 42.8168971]
        },
        "properties": {
          "Name": "Fonda Ángel, Pamplona\n",
          "user": 'Rich',
          "month": "mid-July",
          "days": "",
          "organiser": "Organizers: Sr. Freixas",
          "eventType": "paying-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [2.1763815, 41.3818165]
        },
        "properties": {
          "Name": "Fonógrafo Soley, Barcelona",
          "user": 'Rich',
          "month": "August",
          "days": "",
          "organiser": "?",
          "eventType": "paying-demonstration",
          "notes": ""
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-8.7256683, 42.2382719]
        },
        "properties": {
          "Name": "Café Méndez Núñez, Vigo\n",
          "user": 'Rich',
          "month": "September",
          "days": "21",
          "organiser": "Mr Shelton, from Chicago",
          "eventType": "unknown",
          "notes": ""
        }
      }
    ]
  };

  /* ------------------ Cluster group (the only real layer) ------------------ */

  const clusterGroup = L.markerClusterGroup({
    showCoverageOnHover: false,
    disableClusteringAtZoom: 10,
    chunkedLoading: true
  }).addTo(map);

  /* ------------------ Create markers one time ------------------ */

  const allMarkers = [];

  L.geoJSON(jsontest, {
    pointToLayer: (feature, latlng) => {
      const marker = L.marker(latlng);

      marker.meta = {
        user: feature.properties.user,
        type: feature.properties.eventType
      };

      marker.bindPopup(`
      <strong>${feature.properties.Name}</strong><br>
      user: ${feature.properties.user}<br>
      Type: ${feature.properties.eventType}
    `);

      allMarkers.push(marker);
      return marker;
    }
  });

  /* ------------------ Create dummy layers for UI ------------------ 
  Leaflet.GroupedLayerControl is a good fit as a UI, but the key thing to be very explicit about is this:

  The plugin only groups checkboxes visually.
  It does NOT change Leaflet’s OR logic.

  So we will use it only as a control surface, while keeping your central AND-filtering + clustering logic exactly as before.
  These dummy layers never contain markers.
  They exist only to give the control something to toggle. ------------------ */

  const userLayers = {};
  const typeLayers = {};

  jsontest.features.forEach(f => {
    userLayers[f.properties.user] ??= L.layerGroup();
    typeLayers[f.properties.eventType] ??= L.layerGroup();
  });

  /* ------------------ Set up grouped control ------------------ */

  const groupedOverlays = {
    "Users": userLayers,
    "Log Types": typeLayers
  };

  L.control.groupedLayers(
    objBasemaps,
    groupedOverlays,
    { collapsed: false }
  ).addTo(map);

  /* ------------------ Manage filter state ------------------ */

  // Add dummy layers to map so checkboxes show as checked
  Object.values(userLayers).forEach(layer => map.addLayer(layer));
  Object.values(typeLayers).forEach(layer => map.addLayer(layer));

  // Initialize filter state
  const activeUsers = new Set(Object.keys(userLayers));
  const activeTypes = new Set(Object.keys(typeLayers));

  /* ------------------ Create AND filter ------------------ */

  function applyFilters() {
    clusterGroup.clearLayers();

    allMarkers.forEach(marker => {
      const { user, type } = marker.meta;
      if (activeUsers.has(user) && activeTypes.has(type)) {
        clusterGroup.addLayer(marker);
      }
    });

    // Zoom to fit currently visible markers
    if (clusterGroup.getLayers().length > 0) {
      map.fitBounds(clusterGroup.getBounds(), { padding: [50, 50] });
    }
  }

  /* ------------------ Live counts ------------------ */
  function countUser(user) {
    return allMarkers.filter(m => m.meta.user === user && activeTypes.has(m.meta.type)).length;
  }
  function countType(type) {
    return allMarkers.filter(m => m.meta.type === type && activeUsers.has(m.meta.user)).length;
  }
  function updateCounts() {
    // Select all overlay labels in grouped control
    document.querySelectorAll('.leaflet-control-layers-overlays label').forEach(label => {
      const input = label.querySelector('input');
      if (!input) return;

      // Strip any existing count from the text
      let name = label.querySelector('span')?.textContent || label.textContent;
      name = name.replace(/\s*\(\d+\)$/, '').trim();

      let count = 0;
      if (userLayers[name]) count = countUser(name);
      if (typeLayers[name]) count = countType(name);

      // Update the span or fallback to label text
      const span = label.querySelector('span');
      if (span) {
        span.textContent = `${name} (${count})`;
      } else {
        label.childNodes.forEach(node => {
          if (node.nodeType === 3) node.nodeValue = ` ${name} (${count})`;
        });
      }
    });
  }

  /* ------------------ Control events ------------------ */

  map.on('overlayadd', e => {
    if (userLayers[e.name]) activeUsers.add(e.name);
    if (typeLayers[e.name]) activeTypes.add(e.name);
    applyFilters();
    updateCounts();
  });

  map.on('overlayremove', e => {
    if (userLayers[e.name]) activeUsers.delete(e.name);
    if (typeLayers[e.name]) activeTypes.delete(e.name);
    applyFilters();
    updateCounts();
  });

  /* ------------------ Initial map draw ------------------ */

  applyFilters();
  updateCounts();

</script>